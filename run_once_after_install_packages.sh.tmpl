#!/usr/bin/env bash

set -x
set -e

{{ if .mac }}
if [[ ! -d /opt/homebrew ]]; then
  echo "installing homebrew"
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

if ! command -v brew >/dev/null 2>&1; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

brew bundle -v --file=- <<EOF
brew "mise"

brew "fzf"

brew "bat"
brew "pstree"
brew "pv"
brew "rg"
brew "tree"

brew "direnv"

tap "buo/cask-upgrade"
tap "nao1215/tap"
brew "nao1215/tap/gup"

brew "git"
brew "difftastic"
brew "jq"
brew "yq"
brew "watch"
brew "fswatch"
brew "parallel"
brew "prettyping"
brew "mtr"
brew "rename" # conflicts with linux-util on linux

brew "chezmoi"

brew "zsh"
brew "antigen" # zsh plugins
brew "zsh-syntax-highlighting"

brew "s3cmd"
tap "peak/tap"
brew "peak/tap/s5cmd"

brew "go"
brew "rbenv"
brew "node"
brew "nodenv"
brew "flow" # for javascript typechecking
brew "shellcheck"
brew "rsync"

brew "jj"
brew "jjui"
brew "gh"
brew "mergiraf" # jj merge conflicts
brew "watchman" # for zed ruby
brew "libyaml" # for ruby psych compilation

brew "lunchy"

# for other stuff
cask "font-ia-writer-quattro"
cask "font-merriweather"
cask "font-bricolage-grotesque"
cask "font-inter"

cask "kap" # screen capturing
# cask "wireshark-app"
cask "arq"
cask "raycast"
cask "hammerspoon"
cask "espanso"
cask "iterm2"
cask "1password"
cask "1password-cli"
cask "visual-studio-code"
cask "zed"
cask "obsidian"
cask "istat-menus"
cask "slack"
cask "discord"
cask "google-chrome"
cask "moom"
cask "jordanbaird-ice@beta"
cask "soundsource"
cask "docker-desktop"
cask "qlmarkdown" # markdown quicklook

{{ if .duncan }}
brew "flyctl" # launched, etc.
brew "goaccess" # for access logs
cask "tailscale-app"

tap "hashicorp/tap"
brew "hashicorp/tap/terraform"
{{ end }}

# applications
brew "mas"
EOF

# app store apps
mas install 1451552749  # Open In Webmail
mas install 1351639930  # Gifski
mas install 1528890965  # TextSniper
mas install 1491071483  # Tot
mas install 1547121417  # HomeControl
mas install 1544668450  # Simplify for Gmail
mas install 1569813296  # 1Password for Safari
mas install 411643860   # DaisyDisk
mas install 775737590   # iA Writer
{{ if .duncan }}
# mas install 1640236961  # Save to Reader
mas install 639968404   # Parcel
mas install 6444602274  # Ivory
mas install 1666139593  # Homecoming for Mastodon
mas install 1090488118  # Gemini 2
mas install 1529448980  # Reeder
mas install 6478481082  # openterface
{{ end }}

/opt/homebrew/opt/fzf/install --no-update-rc --key-bindings --completion --xdg

mkdir -p ~/go # for binaries

set +e # this fails sometimes?
eval "$(rbenv init - zsh)"
set -e
# set ruby to the latest version
brew install ruby
brew rbenv-sync -v
latest=$(rbenv versions --bare | sort -V | tail -n 1)
[ "$(rbenv global)" != "$latest" ] && rbenv global "$latest"

[[ -L ~/.ssh ]] || ln -s {{ .chezmoi.homeDir }}/Documents/sync/ssh ~/.ssh

if ! gh auth status -h github.com; then
  echo "gh auth login, cannot continue"
  exit 1
fi
gh md >/dev/null 2>&1 || gh extension install zerowidth/gh-md
gh extension install rneatherway/gh-slack
{{ end }}

{{ if .linux }}
[[ -d ~/.local/share/fzf ]] || git clone --depth 1 https://github.com/junegunn/fzf.git ~/.local/share/fzf
~/.local/share/fzf/install --no-update-rc --key-bindings --completion --xdg

{{ if .shared }}
if ! [[ -f ~/.local/bin/kcat ]]; then
  git clone https://github.com/edenhill/kcat ~/.local/share/kcat
  cd ~/.local/share/kcat && ./bootstrap.sh
  cp ~/.local/share/kcat/kcat ~/.local/bin/kcat
fi

if [ -d ~/.vim/plugins ]; then
  echo "vim plugins already installed, skipping"
 else
  vim --not-a-term +PlugInstall +qa
fi
{{ else }}

if ! command -v zsh >/dev/null 2>&1; then
  sudo apt-get update
  sudo apt-get install -y zsh
fi

sudo apt-get install -y \
  shellcheck \
  bat \
  ripgrep
{{ end -}}

if [[ -n "$(grep $(whoami) /etc/passwd)" ]] && ! grep -q "$(whoami).*/bin/zsh" /etc/passwd; then
  sudo chsh -s /bin/zsh $(whoami)
fi
{{ end }}
